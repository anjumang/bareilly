<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Member Receipt - Anjuman Ghulaman-E-Mustafa</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',system-ui;
    background:linear-gradient(135deg,#f8fafc,#e2e8f0);
    min-height:100vh;
    padding:20px
}
.container{
    max-width:1000px;
    margin:auto;
    background:#fff;
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.1);
    overflow:hidden
}

.receipt-header{
    background:linear-gradient(135deg,#0b4da0,#083a7f);
    color:#fff;
    padding:25px 30px;
    border-bottom:5px solid #10b981
}
.header-top{
    display:flex;
    justify-content:space-between;
    align-items:center
}
.logo{
    width:70px;
    height:70px;
    border-radius:12px;
    background:rgba(255,255,255,.1);
    padding:5px
}
.logo img{
    width:100%;
    height:100%;
    object-fit:contain
}
.header-info{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:15px;
    margin-top:15px
}

.profile-section{
    display:flex;
    gap:30px;
    padding:30px;
    border-bottom:1px solid #e2e8f0
}
.profile-image{
    width:150px;
    height:150px;
    border-radius:50%;
    border:5px solid #e2e8f0;
    object-fit:cover
}
.member-name{
    font-size:2rem;
    color:#0b4da0;
    font-weight:700
}

.payment-table{
    width:100%;
    border-collapse:collapse
}
.payment-table th,
.payment-table td{
    padding:12px;
    border-bottom:1px solid #e2e8f0
}

.summary-cards{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:20px;
    padding:30px
}

.points-display{
    text-align:center;
    padding:40px
}
.progress-bar{
    height:100%;
    background:linear-gradient(90deg,#10b981,#0b4da0)
}

.error-message{
    display:none;
    background:#fee2e2;
    color:#dc2626;
    padding:15px;
    margin:20px;
    border-left:4px solid #dc2626
}

.loading{
    display:none;
    text-align:center;
    padding:30px;
    color:#0b4da0
}
</style>
</head>

<body>
<div class="container">

<!-- LOADING -->
<div id="loading" class="loading">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <p>Loading receipt data...</p>
</div>

<!-- HEADER -->
<div class="receipt-header">
    <div class="header-top">
        <div class="logo">
            <img src="https://anjumang.github.io/bareilly/img/logo.png" alt="AGM">
        </div>
        <div id="lastUpdatedTime"></div>
    </div>

    <div class="header-info">
        <div>Receipt: <span id="receiptNumber"></span></div>
        <div>Date: <span id="currentDate"></span></div>
        <div>Status: <span id="memberStatus">Loading</span></div>
    </div>
</div>

<!-- ERROR -->
<div id="errorMessage" class="error-message">
    <i class="fas fa-exclamation-triangle"></i>
    <span id="errorText">UID missing in URL</span>
</div>

<!-- CONTENT (Hidden until data loads) -->
<div id="contentArea">
    <!-- PROFILE -->
    <div class="profile-section">
        <img id="memberImage" class="profile-image" src="">
        <div>
            <div id="memberName" class="member-name"></div>
            <div id="memberPhone"></div>
            <div>Member Since: <span id="memberSince"></span></div>
        </div>
    </div>

    <!-- PAYMENT TABLE -->
    <table class="payment-table">
    <thead>
    <tr>
        <th>#</th>
        <th>Date</th>
        <th>Month</th>
        <th>Payment</th>
        <th>Points</th>
    </tr>
    </thead>
    <tbody id="paymentHistory"></tbody>
    </table>

    <!-- SUMMARY -->
    <div class="summary-cards">
        <div>Total Paid: ₹<span id="totalPaid">0</span></div>
        <div>Pending: ₹<span id="pending">0</span></div>
        <div>Completion: <span id="completion">0%</span></div>
        <div>Total Points: <span id="totalPoints">0</span></div>
    </div>

    <!-- POINTS -->
    <div class="points-display">
        <div id="displayPoints" style="font-size:48px;font-weight:700">0</div>
        <div style="height:12px;background:#e2e8f0;margin-top:15px">
            <div id="progressBar" class="progress-bar" style="width:0%"></div>
        </div>
        <div id="progressText"></div>
    </div>
</div>

</div>

<script>
/* ================= UID BASED RECEIPT ================= */

const params = new URLSearchParams(window.location.search);
const uid = params.get("uid");

const now = new Date();
document.getElementById("currentDate").innerText =
    now.toLocaleDateString("en-IN");
document.getElementById("lastUpdatedTime").innerText =
    now.toLocaleTimeString("en-IN");
document.getElementById("receiptNumber").innerText =
    "AGM/" + now.getFullYear() + "/" + Math.floor(1000 + Math.random()*9000);

async function loadData(){
    // Hide content, show loading
    document.getElementById("contentArea").style.display = "none";
    document.getElementById("loading").style.display = "block";
    document.getElementById("errorMessage").style.display = "none";
    
    if(!uid){
        showError("UID missing in URL. Please provide a valid member ID.");
        document.getElementById("loading").style.display = "none";
        return;
    }

    try{
        // DIRECT API CALL - CORS header is now in api.php
        const apiUrl = "https://anjumang.infinityfreeapp.com/api.php?uid=" + encodeURIComponent(uid);
        const res = await fetch(apiUrl);
        
        if(!res.ok){
            throw new Error(`Server error: ${res.status}`);
        }
        
        const json = await res.json();
        
        if(!json.success){
            throw new Error(json.message || "Member not found");
        }

        const d = json.data;

        // Hide loading, show content
        document.getElementById("loading").style.display = "none";
        document.getElementById("contentArea").style.display = "block";
        
        // Update UI with data
        document.getElementById("memberStatus").innerText = "Active";
        document.getElementById("memberName").innerText  = d.name || "N/A";
        document.getElementById("memberPhone").innerText = d.phone || "Not Available";
        document.getElementById("memberSince").innerText = d.member_since || "2025";
        
        // Set image with fallback
        const memberImage = document.getElementById("memberImage");
        if(d.image && d.image.trim() !== ""){
            memberImage.src = d.image;
        } else {
            memberImage.src = "https://via.placeholder.com/150/0b4da0/ffffff?text=AGM";
        }
        
        memberImage.onerror = function(){
            this.src = "https://via.placeholder.com/150/0b4da0/ffffff?text=AGM";
        };

        // Process payments
        let totalPaid = 0;
        let totalPoints = 0;
        const tbody = document.getElementById("paymentHistory");
        tbody.innerHTML = "";

        if(d.payments && Array.isArray(d.payments)){
            d.payments.forEach((p,i)=>{
                const payment = Number(p.payment || 0);
                const point = Number(p.point || 0);
                totalPaid   += payment;
                totalPoints += point;

                tbody.innerHTML += `
                <tr>
                    <td>${i+1}</td>
                    <td>${p.date || ""}</td>
                    <td>${p.month || ""}</td>
                    <td>₹${payment}</td>
                    <td>${point}</td>
                </tr>`;
            });
        }

        // If no payments, show message
        if(!d.payments || d.payments.length === 0){
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No payment history found</td></tr>`;
        }

        // Use data from API or calculate
        const finalTotalPaid = d.total_paid || totalPaid;
        const finalTotalPoints = d.total_points || totalPoints;

        // Calculate completion (assuming target of 1200)
        const target = 1200;
        const completion = Math.round((finalTotalPaid/target)*100);

        document.getElementById("totalPaid").innerText     = finalTotalPaid;
        document.getElementById("pending").innerText       = Math.max(0, target - finalTotalPaid);
        document.getElementById("completion").innerText    = Math.min(100, completion) + "%";
        document.getElementById("totalPoints").innerText   = finalTotalPoints;
        document.getElementById("displayPoints").innerText = finalTotalPoints;

        // Progress bar (assuming target of 500 points for 100%)
        const pointsTarget = 500;
        const prog = Math.min(100, (finalTotalPoints/pointsTarget)*100);
        document.getElementById("progressBar").style.width = prog + "%";
        document.getElementById("progressText").innerText  =
            prog.toFixed(1) + "% Complete";

    }catch(err){
        document.getElementById("loading").style.display = "none";
        showError("Error: " + err.message);
        console.error("Fetch error:", err);
    }
}

function showError(msg){
    document.getElementById("errorText").innerText = msg;
    document.getElementById("errorMessage").style.display = "block";
}

// Load data when page loads
document.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>
