<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Receipt - Anjuman Ghulaman-E-Mustafa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --green-1: #0f8a63;
            --green-2: #0a6b4f;
            --accent: #10b981;
            --muted: #f3f7f9;
            --blue: #0b4da0;
            --card-bg: #ffffff;
            --shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
            --radius: 12px;
            font-family: "Segoe UI", Roboto, "Noto Sans", Arial, sans-serif;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background: linear-gradient(180deg, #eef6f4 0%, #f9fcfd 100%);
            color: #1f2937;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 16px;
            color: var(--blue);
            font-weight: 600;
        }
        
        .progress-bar {
            width: 300px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green-1), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Header */
        .header {
            background: linear-gradient(90deg, var(--green-1), var(--green-2));
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(-10px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .header .top {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            background: #073b2a;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        .title {
            flex: 1;
            min-width: 250px;
        }
        
        .title h1 {
            margin: 0;
            font-size: 20px;
        }
        
        .title p {
            margin: 4px 0 0;
            font-size: 13px;
            opacity: 0.95;
        }
        
        /* Profile Section */
        .profile {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: var(--shadow);
            margin-top: 15px;
            opacity: 0;
            animation: fadeInUp 0.5s ease 0.2s forwards;
        }
        
        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            background: #f2f5f6;
            border: 4px solid var(--card-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .info {
            flex: 1;
        }
        
        .info .row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .info .label {
            min-width: 100px;
            color: #374151;
            font-weight: 700;
            font-size: 15px;
        }
        
        .info .val {
            font-weight: 600;
            color: #0b1220;
            font-size: 16px;
        }
        
        /* Table */
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: #0b4da0;
            margin: 20px 0 12px;
            padding: 8px 0;
            border-bottom: 2px solid #eef3f6;
            opacity: 0;
            animation: fadeInUp 0.5s ease 0.3s forwards;
        }
        
        table.receipt {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInUp 0.5s ease 0.4s forwards;
        }
        
        table.receipt thead th {
            background: linear-gradient(180deg, #0b4da0, #083a7f);
            color: #fff;
            padding: 14px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
        }
        
        table.receipt tbody td {
            padding: 12px 10px;
            border-bottom: 1px solid #eef3f6;
            font-size: 14px;
            color: #263238;
        }
        
        table.receipt tbody tr:nth-child(even) {
            background: #fbfeff;
        }
        
        /* Summary Cards */
        .summaries {
            display: flex;
            gap: 16px;
            margin-top: 20px;
            flex-wrap: wrap;
            opacity: 0;
            animation: fadeInUp 0.5s ease 0.5s forwards;
        }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            flex: 1;
            min-width: 220px;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--blue);
        }
        
        .card h3 {
            margin: 0 0 12px;
            font-size: 17px;
            color: #0b4da0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-weight: 600;
            border-bottom: 1px dashed #e5e7eb;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .profile {
                flex-direction: column;
                text-align: center;
            }
            
            .info .row {
                flex-direction: column;
                gap: 4px;
                align-items: center;
            }
            
            .info .label {
                min-width: auto;
            }
            
            .avatar {
                width: 100px;
                height: 100px;
            }
            
            .card {
                min-width: 100%;
            }
            
            .progress-bar {
                width: 250px;
            }
        }
        
        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .progress-bar {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Loading receipt data...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <div class="top">
                <div class="logo">
                    <img src="https://anjumang.github.io/bareilly/img/logo.png" alt="AGM Logo">
                </div>
                <div class="title">
                    <h1>Anjuman Ghulamane Mustafa</h1>
                    <p>Official Membership Receipt</p>
                    <div id="lastUpdated" style="font-size:11px;opacity:0.9;margin-top:4px">
                        Last updated: <span id="updateTime"></span>
                    </div>
                </div>
            </div>

            <div class="profile">
                <div class="avatar">
                    <img id="avatarImg" src="https://via.placeholder.com/120" alt="Member Photo">
                </div>
                <div class="info">
                    <div class="row"><div class="label">Member:</div><div class="val" id="name">Loading...</div></div>
                    <div class="row"><div class="label">Mobile:</div><div class="val" id="mobile">--</div></div>
                    <div class="row"><div class="label">Date:</div><div class="val" id="date">--</div></div>
                    <div class="row"><div class="label">Status:</div><div class="val" id="status">--</div></div>
                </div>
            </div>
        </div>

        <div class="section-title">
            <i class="fas fa-history"></i>
            Payment History
        </div>

        <table class="receipt">
            <thead>
                <tr>
                    <th>Sr.</th>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Month</th>
                    <th>Payment</th>
                    <th>Points</th>
                </tr>
            </thead>
            <tbody id="tbody">
                <!-- Data will be loaded here -->
            </tbody>
        </table>

        <div class="summaries">
            <div class="card">
                <h3><i class="fas fa-rupee-sign"></i> Financial Summary</h3>
                <div class="summary-row">
                    <div>Total Paid:</div>
                    <div id="sumPaid">₹0</div>
                </div>
                <div class="summary-row">
                    <div>Pending Amount:</div>
                    <div id="sumPending">₹0</div>
                </div>
                <div class="summary-row">
                    <div>Target Amount:</div>
                    <div id="sumTarget">₹1200</div>
                </div>
                <div class="summary-row">
                    <div>Completion:</div>
                    <div id="completion">0%</div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-star"></i> Points Summary</h3>
                <div class="summary-row">
                    <div>Total Points:</div>
                    <div id="pointsTotal">0</div>
                </div>
                <div class="summary-row">
                    <div>Max Points:</div>
                    <div id="maxPoints">500</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SPREADSHEET_ID = '1vZjFjqXWbzKjul-Jg0SkEZZMOekmNDTKDw-NWROhBzaVO3hHEAr5z2smU';
        const API_KEY = 'AIzaSyChkzAQhEqFR5nD9uBzaVO3hHEAr5z2smU';
        const PAYMENT_SHEET_NAME = 'Sheet53';
        
        // DOM Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const progressFill = document.getElementById('progressFill');
        const mainContent = document.getElementById('mainContent');
        
        // URL Parameters
        const urlParams = new URLSearchParams(window.location.search);
        const memberName = decodeURIComponent(urlParams.get('name') || 'Member');
        const cachedDataAvailable = urlParams.get('cached') === 'true';
        
        // Update progress bar
        function updateProgress(percentage, text) {
            progressFill.style.width = percentage + '%';
            if (text) loadingText.textContent = text;
        }
        
        // Hide loading and show content
        function showContent() {
            loadingOverlay.style.display = 'none';
            mainContent.style.display = 'block';
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
        }
        
        // Set initial data from URL parameters (FAST LOADING)
        function setInitialData() {
            updateProgress(30, 'Loading member details...');
            
            document.getElementById('name').textContent = memberName;
            document.getElementById('date').textContent = new Date().toLocaleDateString('en-GB');
            
            // Use cached data if available (VERY FAST)
            if (cachedDataAvailable) {
                document.getElementById('mobile').textContent = decodeURIComponent(urlParams.get('cachedPhone') || 'N/A');
                document.getElementById('avatarImg').src = decodeURIComponent(urlParams.get('cachedImage') || 'https://via.placeholder.com/120');
                
                const cachedPoints = parseInt(urlParams.get('cachedPoints') || '0');
                document.getElementById('pointsTotal').textContent = cachedPoints;
                
                // Set status based on cached points
                updateStatus(cachedPoints);
            }
        }
        
        // Update status based on payment completion
        function updateStatus(totalPoints) {
            const statusElement = document.getElementById('status');
            const targetAmount = 1200;
            const completion = Math.round((totalPoints / 500) * 100); // Assuming 500 points = 100%
            
            if (completion === 100) {
                statusElement.textContent = "Payment Complete ✓";
                statusElement.style.color = "#059669";
            } else if (completion >= 50) {
                statusElement.textContent = "Active Member";
                statusElement.style.color = "#0b4da0";
            } else {
                statusElement.textContent = "Payment Pending";
                statusElement.style.color = "#dc2626";
            }
            
            document.getElementById('completion').textContent = completion + '%';
        }
        
        // OPTIMIZED: Fetch only specific member's payment data using R1C1 notation
        async function fetchMemberPayments() {
            updateProgress(50, 'Fetching payment history...');
            
            try {
                // Instead of fetching entire sheet, we'll fetch and filter
                // Note: Google Sheets API doesn't support direct filtering by value in query
                // So we fetch all and filter client-side but with optimizations
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${PAYMENT_SHEET_NAME}?key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateProgress(80, 'Processing payment data...');
                
                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    
                    // Find column indices
                    const nameIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('name'));
                    const dateIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('date'));
                    const monthIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('month'));
                    const paymentIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('payment'));
                    const pointsIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('point'));
                    
                    // Filter rows for this specific member
                    const memberRows = rows.filter(row => 
                        row[nameIndex] && 
                        row[nameIndex].toString().trim().toLowerCase() === memberName.toLowerCase()
                    );
                    
                    updateProgress(90, 'Rendering receipt...');
                    displayPaymentData(memberRows, {
                        nameIndex, dateIndex, monthIndex, paymentIndex, pointsIndex
                    });
                    
                    // Calculate totals
                    calculateTotals(memberRows, paymentIndex, pointsIndex);
                } else {
                    showNoData();
                }
                
                updateProgress(100, 'Receipt ready!');
                setTimeout(showContent, 300);
                
            } catch (error) {
                console.error('Error fetching payment data:', error);
                loadingText.textContent = 'Error loading data. Using cached information...';
                setTimeout(showContent, 1000);
            }
        }
        
        // Display payment data in table
        function displayPaymentData(rows, indices) {
            const tbody = document.getElementById('tbody');
            
            if (rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center;padding:30px;color:#6b7280">
                            <i class="fas fa-inbox" style="font-size:24px;margin-bottom:10px;display:block;"></i>
                            No payment records found for this member
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            rows.forEach((row, index) => {
                const payment = parseFloat(row[indices.paymentIndex]) || 0;
                const points = parseInt(row[indices.pointsIndex]) || 0;
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${row[indices.nameIndex] || memberName}</td>
                        <td>${row[indices.dateIndex] || 'N/A'}</td>
                        <td>${row[indices.monthIndex] || 'N/A'}</td>
                        <td>${payment > 0 ? '₹' + payment : '-'}</td>
                        <td>${points > 0 ? points : '0'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Calculate and display totals
        function calculateTotals(rows, paymentIndex, pointsIndex) {
            let totalPaid = 0;
            let totalPoints = 0;
            
            rows.forEach(row => {
                totalPaid += parseFloat(row[paymentIndex]) || 0;
                totalPoints += parseInt(row[pointsIndex]) || 0;
            });
            
            const targetAmount = 1200;
            const pending = Math.max(0, targetAmount - totalPaid);
            const completion = Math.round((totalPaid / targetAmount) * 100);
            
            document.getElementById('sumPaid').textContent = '₹' + totalPaid;
            document.getElementById('sumPending').textContent = pending === 0 ? '₹0' : '₹' + pending;
            document.getElementById('completion').textContent = completion + '%';
            document.getElementById('pointsTotal').textContent = totalPoints;
            
            // Update status with actual payment data
            updateStatus(totalPoints);
        }
        
        // Show no data message
        function showNoData() {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align:center;padding:30px;color:#6b7280">
                        No payment data available
                    </td>
                </tr>
            `;
        }
        
        // Initialize everything when page loads
        window.addEventListener('DOMContentLoaded', () => {
            // Step 1: Set initial data from URL params (instantly)
            setInitialData();
            
            // Step 2: Fetch payment data (async, won't block UI)
            setTimeout(() => {
                fetchMemberPayments();
            }, 100);
            
            // Step 3: If no cached data, try to fetch member image from Sheet1
            if (!cachedDataAvailable) {
                setTimeout(fetchMemberImage, 500);
            }
        });
        
        // Optional: Fetch member image from Sheet1 if not cached
        async function fetchMemberImage() {
            try {
                const memberUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1?key=${API_KEY}`;
                const response = await fetch(memberUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.values) {
                        const memberRow = data.values.find(row => 
                            row[0] && row[0].toString().trim().toLowerCase() === memberName.toLowerCase()
                        );
                        
                        if (memberRow && memberRow[3]) {
                            document.getElementById('avatarImg').src = memberRow[3];
                            document.getElementById('mobile').textContent = memberRow[1] || 'N/A';
                        }
                    }
                }
            } catch (error) {
                // Silently fail - we already have cached data
            }
        }
    </script>
</body>
</html>
