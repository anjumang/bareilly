<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anjuman Ghulaman-E-Mustafa</title>

<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/custom.css" rel="stylesheet">

<style>
.member-link{
    color:#0b4da0;
    cursor:pointer;
    font-weight:600;
    text-decoration:none;
}
.member-link:hover{ text-decoration:underline }

.modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.8);
    z-index:9999;
}
.modal-content{
    width:95%;
    height:90vh;
    margin:2% auto;
    background:#fff;
    border-radius:12px;
    overflow:hidden;
}
.modal iframe{
    width:100%;
    height:100%;
    border:none;
}
.close-modal{
    position:absolute;
    right:20px;
    top:15px;
    width:40px;
    height:40px;
    border-radius:50%;
    background:rgba(0,0,0,.6);
    color:#fff;
    font-size:28px;
    text-align:center;
    line-height:40px;
    cursor:pointer;
    z-index:10000;
}
</style>
</head>

<body>

<div class="container-fluid">
    <div class="row" id="dynamic-data"></div>
</div>

<!-- RECEIPT POPUP -->
<div id="receiptModal" class="modal">
    <span class="close-modal" onclick="closeModal()">×</span>
    <div class="modal-content">
        <iframe id="receiptFrame"></iframe>
    </div>
</div>

<script>
/* ================= GOOGLE SHEET CONFIG ================= */
const sheetId = "1vZjFjqXWbzKjul-Jg0SkEZZMOekmNDTKDw-NWROhBcw";
const apiKey  = "AIzaSyChkzAQhEqFR5nD9uBzaVO3hHEAr5z2smU";
const range   = "Sheet1!A2:H";

/* ================= MODAL ================= */
const modal = document.getElementById("receiptModal");
const receiptFrame = document.getElementById("receiptFrame");

function openReceiptModal(uid){
    receiptFrame.src =
      "https://anjumang.github.io/bareilly/receipt.html?uid="
      + encodeURIComponent(uid);

    modal.style.display = "block";
    document.body.style.overflow = "hidden";
}

function closeModal(){
    modal.style.display = "none";
    receiptFrame.src = "";
    document.body.style.overflow = "auto";
}

// Close modal when clicking outside
window.onclick = function(event){
    if(event.target == modal){
        closeModal();
    }
}

/* ================= LOAD DATA ================= */
async function loadData(){
    const url =
      `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

    const box = document.getElementById("dynamic-data");
    box.innerHTML = "<p class='text-center'>Loading...</p>";

    try{
        const res  = await fetch(url);
        const json = await res.json();
        const data = json.values || [];

        box.innerHTML = "";

        if(data.length === 0){
            box.innerHTML = "<p class='text-center'>No data found</p>";
            return;
        }

        // Sort by points (DESC)
        data.sort((a,b)=> (Number(b[2]||0) - Number(a[2]||0)));

        data.forEach((row,i)=>{

            const name   = row[0] || "N/A";
            const phone  = row[1] || "N/A";
            const points = row[2] || 0;
            const image  = row[3] || "img/default-avatar.png";
            const uid    = row[7]; // ✅ UID (H column)

            if(!uid) return;

            const div = document.createElement("div");
            div.className = "col-md-4 col-12 mb-4";

            div.innerHTML = `
            <div class="cand-box">
                <figure>
                    <img src="${image}"
                         style="width:100px;height:100px;border-radius:50%;object-fit:cover"
                         alt="${name}">
                </figure>

                <div class="cand-info">
                    <div class="status member">
                        <div>Rank #${i+1}</div>
                        <div>Total Points: (${points})</div>
                    </div>

                    <div class="nme-prty">
                        <h5>
                            <a class="member-link"
                               onclick="openReceiptModal('${uid}')">
                               ${name}
                            </a>
                        </h5>
                        <h6>${phone}</h6>
                    </div>
                </div>
            </div>`;
            box.appendChild(div);
        });

    }catch(e){
        console.error(e);
        box.innerHTML = "<p class='text-center'>Error loading data</p>";
    }
}

window.onload = loadData;
</script>

</body>
</html>
