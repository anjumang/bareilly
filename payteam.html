<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Barafat Committee - Payment Collection Dashboard</title>
<style>
:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --light-color: #ecf0f1;
    --success-color: #27ae60;
    --warning-color: #f39c12;
}
* {margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body {background-color:#f5f7fa; color:#333; line-height:1.6;}
.container {max-width:1200px; margin:0 auto; padding:20px;}
header {background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:white; padding:20px 0; border-radius:10px; margin-bottom:30px; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
.header-content {display:flex; justify-content:space-between; align-items:center; padding:0 20px;}
h1 {font-size:28px; margin-bottom:5px;}
.subtitle {font-size:16px; opacity:0.9;}
.stats-container {display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:20px; margin-bottom:30px;}
.stat-card {background:white; border-radius:10px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; transition: transform 0.3s ease;}
.stat-card:hover {transform:translateY(-5px);}
.stat-value {font-size:32px; font-weight:bold; color:var(--primary-color); margin:10px 0;}
.stat-label {color:#7f8c8d; font-size:14px;}
.teams-container {display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:25px;}
.team-card {background:white; border-radius:10px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.1); transition: transform 0.3s ease;}
.team-card:hover {transform:translateY(-5px);}
.team-header {background:var(--secondary-color); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;}
.team-name {font-size:18px; font-weight:bold;}
.collection-amount {background:var(--accent-color); padding:5px 10px; border-radius:20px; font-size:14px;}
.team-members {padding:15px;}
.member-list {list-style-type:none;}
.member-item {padding:10px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; cursor:pointer;}
.member-item:last-child {border-bottom:none;}
.member-name {font-weight:500;}
.member-collector {color:var(--secondary-color); font-size:14px;}
.controls {display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px;}
.search-box, .filter-select {padding:10px 15px; border:1px solid #ddd; border-radius:5px;}
.export-btn {background:var(--success-color); color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; transition:0.3s;}
.export-btn:hover {background:#219653;}
.sync-btn {background:var(--secondary-color); color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; transition:0.3s;}
.sync-btn:hover {background:#2980b9;}
footer {text-align:center; margin-top:40px; padding:20px; color:#7f8c8d; font-size:14px;}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;}
.modal-content {background:white; padding:20px; border-radius:10px; width:90%; max-width:600px; max-height:80vh; overflow-y:auto;}
.modal-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;}
.close-btn {background:none; border:none; font-size:24px; cursor:pointer; color:#7f8c8d;}
.payment-grid {display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px;}
.payment-cell {padding:8px; text-align:center; border-radius:5px; cursor:pointer;}
.paid {background-color:var(--success-color); color:white;}
.unpaid {background-color:#f5f5f5; color:#333;}
.month-label {font-size:12px; margin-bottom:5px; text-align:center;}
.payment-status {display:flex; align-items:center; gap:5px;}
.payment-dot {width:10px; height:10px; border-radius:50%; display:inline-block;}
.paid-dot {background-color:var(--success-color);}
.unpaid-dot {background-color:#e0e0e0;}
@media(max-width:768px){
.header-content{flex-direction:column;text-align:center;}
.controls{flex-direction:column;}
.search-box,.filter-select,.export-btn,.sync-btn{width:100%;}
.payment-grid{grid-template-columns:repeat(3,1fr);}
}
</style>
</head>
<body>
<div class="container">
    <header>
        <div class="header-content">
            <div>
                <h1>Barafat Committee</h1>
                <p class="subtitle">Payment Collection Dashboard</p>
            </div>
            <div>
                <p>Last Updated: <span id="last-updated">Loading...</span></p>
            </div>
        </div>
    </header>

    <div class="stats-container">
        <div class="stat-card"><div class="stat-label">Total Teams</div><div class="stat-value" id="total-teams">0</div></div>
        <div class="stat-card"><div class="stat-label">Total Members</div><div class="stat-value" id="total-members">0</div></div>
        <div class="stat-card"><div class="stat-label">Monthly Target</div><div class="stat-value" id="monthly-target">0</div></div>
        <div class="stat-card"><div class="stat-label">Collection Progress</div><div class="stat-value" id="collection-progress">0%</div></div>
    </div>

    <div class="controls">
        <input type="text" class="search-box" placeholder="Search team or member..." id="search-input">
        <select class="filter-select" id="team-filter"><option value="all">All Teams</option></select>
        <select class="filter-select" id="month-filter"><option value="all">All Months</option></select>
        <button class="sync-btn" id="sync-btn">Sync with Google Sheets</button>
        <button class="export-btn" id="export-btn">Export to Excel</button>
    </div>

    <div class="teams-container" id="teams-container"></div>

    <footer><p>Barafat Committee Payment Collection System &copy; 2023</p></footer>
</div>

<div class="modal" id="payment-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Payment Details</h2>
            <button class="close-btn" id="close-modal">&times;</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
const SPREADSHEET_ID = '1JQpmcl8UTThTw1LdZFyYg5ODRk661FN78RCYEXJV8bM';
const API_KEY = 'AIzaSyDyYGbNGoxSmOCxM3AWIByds9g0zbOUY-g';
const SHEET_RANGE = 'Sheet1'; // ðŸ”¹ Full Sheet Data Load

let teamData = [];

function cellIsPaid(val){
    if(!val) return false;
    const s = String(val).trim().toLowerCase();
    return ['paid','yes','true','1','p','done','ok','100','â‚¹100'].includes(s);
}

async function loadDataFromSheets(){
    try{
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`;
        const resp = await fetch(url);
        if(!resp.ok) throw new Error(resp.statusText);
        const json = await resp.json();
        const rows = json.values || [];
        if(rows.length < 2){teamData = []; renderTeams([]); updateStatistics(); return;}
        
        const headers = rows[0].map(h => h.trim().toLowerCase());
        const collectorIdx = headers.findIndex(h => ['collector','team','collector name','collector_name'].includes(h));
        const memberIdx = headers.findIndex(h => ['member','member name','name','full name','member_name'].includes(h));
        const cIdx = collectorIdx !== -1 ? collectorIdx : 0;
        const mIdx = memberIdx !== -1 ? memberIdx : 1;

        const monthIdxs = headers.map((h,i)=>i).slice(2); 
        const grouped = {};
        for(let r=1;r<rows.length;r++){
            const row = rows[r];
            const collector = (row[cIdx] || 'Unknown').trim();
            const name = (row[mIdx] || `Member ${r}`).trim();
            const payments = monthIdxs.map(i => cellIsPaid(row[i]));
            if(!grouped[collector]) grouped[collector] = {collector, members: []};
            grouped[collector].members.push({name, payments});
        }
        teamData = Object.keys(grouped).map(k => grouped[k]);
        renderTeams(teamData);
        populateTeamFilter();
        populateMonthFilter();
        updateStatistics();
        document.getElementById('last-updated').textContent = new Date().toLocaleString();
    }catch(err){
        console.error(err);
        alert('Error loading Google Sheet data');
    }
}

function calculateTeamAmount(team){
    const monthlyPayment = 100;
    let total = 0;
    team.members.forEach(m => {
        total += m.payments.filter(p => p).length * monthlyPayment;
    });
    return total;
}

function renderTeams(teams){
    const container = document.getElementById('teams-container');
    container.innerHTML = '';
    teams.forEach(team => {
        const teamAmount = calculateTeamAmount(team);
        const teamCard = document.createElement('div');
        teamCard.className = 'team-card';
        teamCard.innerHTML = `
        <div class="team-header">
            <div class="team-name">${team.collector}</div>
            <div class="collection-amount">â‚¹${teamAmount}</div>
        </div>
        <div class="team-members">
            <ul class="member-list">
                ${team.members.map(m=>{
                    const paidMonths = m.payments.filter(p=>p).length;
                    const amountPaid = paidMonths * 100;
                    return `
                    <li class="member-item" data-member="${m.name}" data-collector="${team.collector}">
                        <span class="member-name">${m.name}</span>
                        <div class="payment-status">
                            <span class="payment-dot ${paidMonths>0 ? 'paid-dot' : 'unpaid-dot'}"></span>
                            <span class="member-collector">â‚¹${amountPaid}</span>
                        </div>
                    </li>`;
                }).join('')}
            </ul>
        </div>`;
        container.appendChild(teamCard);
    });
    document.querySelectorAll('.member-item').forEach(item =>
        item.addEventListener('click', function(){
            showPaymentModal(this.getAttribute('data-member'), this.getAttribute('data-collector'));
        })
    );
}

function showPaymentModal(memberName, collector){
    const modal = document.getElementById('payment-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const team = teamData.find(t => t.collector === collector);
    if(!team) return;
    const member = team.members.find(m => m.name === memberName);
    if(!member) return;

    modalTitle.textContent = `Payment Details - ${memberName}`;
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    let gridHTML = '<div class="payment-grid">';
    member.payments.forEach((p,i)=>{
        gridHTML += `<div><div class="month-label">${monthNames[i]}</div>
        <div class="payment-cell ${p?'paid':'unpaid'}">${p?'Paid':'Unpaid'}</div></div>`;
    });
    gridHTML += '</div>';
    modalBody.innerHTML = gridHTML;
    modal.style.display = 'flex';
}

document.getElementById('close-modal').addEventListener('click',()=>document.getElementById('payment-modal').style.display='none');
document.getElementById('payment-modal').addEventListener('click',e=>{
    if(e.target===document.getElementById('payment-modal')) document.getElementById('payment-modal').style.display='none';
});

function updateStatistics(){
    document.getElementById('total-teams').textContent = teamData.length;
    const totalMembers = teamData.reduce((t,team)=>t+(team.members?team.members.length:0),0);
    document.getElementById('total-members').textContent = totalMembers;
    document.getElementById('monthly-target').textContent = totalMembers*100;
    const totalCollected = teamData.reduce((t,team)=>t+calculateTeamAmount(team),0);
    const totalPossible = totalMembers*100*12;
    document.getElementById('collection-progress').textContent = totalPossible>0 ? Math.round((totalCollected/totalPossible)*100)+'%' : '0%';
}

function populateTeamFilter(){
    const filter = document.getElementById('team-filter');
    const prev = filter.value || 'all';
    filter.innerHTML = '<option value="all">All Teams</option>';
    teamData.forEach(team=>{
        const option = document.createElement('option');
        option.value = team.collector;
        option.textContent = team.collector;
        filter.appendChild(option);
    });
    if([...filter.options].some(o=>o.value===prev)) filter.value = prev;
}

function populateMonthFilter(){
    const filter = document.getElementById('month-filter');
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    filter.innerHTML = '<option value="all">All Months</option>';
    monthNames.forEach((m,i)=>{
        const option = document.createElement('option');
        option.value = i;
        option.textContent = m;
        filter.appendChild(option);
    });
}

function filterTeams(){
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const selectedTeam = document.getElementById('team-filter').value;
    const selectedMonth = document.getElementById('month-filter').value;
    const filtered = teamData.map(t=>({...t,members:t.members.slice()})).filter(team=>{
        if(selectedTeam!=='all' && team.collector!==selectedTeam) return false;
        let membersFiltered = team.members.filter(m=>m.name.toLowerCase().includes(searchTerm));
        if(searchTerm==='') membersFiltered = team.members;
        if(selectedMonth!=='all'){
            const idx = parseInt(selectedMonth);
            membersFiltered = membersFiltered.filter(m=>m.payments[idx]);
        }
        team.members = membersFiltered;
        return team.members.length>0;
    });
    renderTeams(filtered);
}

async function syncWithGoogleSheets(){
    const btn = document.getElementById('sync-btn');
    btn.textContent = 'Syncing...';
    btn.disabled = true;
    try{ await loadDataFromSheets(); }
    catch(e){ alert('Error syncing'); console.error(e); }
    finally{
        btn.textContent = 'Sync with Google Sheets';
        btn.disabled = false;
    }
}

function exportToExcel(){
    let csv="Collector,Member,Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec\n";
    teamData.forEach(team=>{
        team.members.forEach(m=>{
            const payments = m.payments.map(p=>p?'Paid':'Unpaid').join(',');
            csv+=`"${team.collector}","${m.name}",${payments}\n`;
        });
    });
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='barafat_committee_payments.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('Data exported successfully!');
}

document.addEventListener('DOMContentLoaded',function(){
    loadDataFromSheets();
    setInterval(loadDataFromSheets,10000);
    document.getElementById('search-input').addEventListener('input',filterTeams);
    document.getElementById('team-filter').addEventListener('change',filterTeams);
    document.getElementById('month-filter').addEventListener('change',filterTeams);
    document.getElementById('sync-btn').addEventListener('click',syncWithGoogleSheets);
    document.getElementById('export-btn').addEventListener('click',exportToExcel);
});
</script>
</body>
</html>